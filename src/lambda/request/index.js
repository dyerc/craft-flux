"use strict";var q=require("crypto");function u(e,...t){e.loggingEnabled&&console.log(t)}function F(e){return typeof e!="string"?!1:!isNaN(e)&&!isNaN(parseFloat(e))}var P="webp",C=(r=>(r.FIT="fit",r.CROP="crop",r.STRETCH="stretch",r))(C||{}),S=["jpg","png","webp"],U=["top-left","top-center","top-right","center-left","center-center","center-right","bottom-left","bottom-center","bottom-right"];function d(e,t){return Number.isInteger(parseInt(e))?parseInt(e):t}function j(e){return e.headers.accept?e.headers.accept[0].value:""}function A(e){let t=e.match(/_(\d+|AUTO)x(\d+|AUTO)_(fit|crop|stretch)_([a-z\d\\.]+-[a-z\d\\.]+)_?(\d+)?/);return t?t[0]:void 0}function R(e,t,n){if(!t.v)return!1;let r=n.verifySecret,o=e.uri.substring(1);o=T(o,n);let i=e.querystring.split("&v=");return Object.keys(t).length>1&&i.length===2?(0,q.createHmac)("sha256",r).update(`${o}?${i[0]}`).digest("hex")===i[1]:!1}function v(e,t,n){let r=e.uri,o=j(e),i=r.match(/(.*)\/(.*)\.(.*)$/);if(!i||i.length<3)return null;let s=i[1];s.charAt(0)==="/"&&(s=s.substring(1));let l=i[2],g=i[3],c,a=g;e.headers["x-flux-source-filename"]&&(c=e.headers["x-flux-source-filename"][0].value);let x=A(s),h=T(s.replace(`/${x}`,""),n),p=h.split("/").filter(f=>f),b=n.sources.find(f=>{let m=p[0];return m===n.rootPrefix&&(m=p[1]),f.handle===m});if(!b)return u(n,"Unable to parse source",h),u(n,"Available sources",n.sources.map(f=>f.handle)),null;let E=$(...p.slice(1));t.f&&S.includes(t.f)?a=t.f:n.acceptWebp&&o.includes(P)&&(a=P),!c&&g!==a&&(c=`${l}.${g}`);let y=M(t,a,n);return y?{prefix:s,fileName:l,extension:a,manipulations:y,source:b,sourcePath:E,sourceFilename:c,transformPathSegment:x}:null}function M(e,t,n){if(!e.mode||!e.w&&!e.h)return u(n,"Request must contain a mode and a width or height"),null;let r={mode:Object.values(C).includes(e.mode)?e.mode:"fit",width:"AUTO",height:"AUTO",position:"center-center"};if(r.width=d(e.w,r.width),r.height=d(e.h,r.height),e.pos){if(U.includes(e.pos))r.position=e.pos;else if(!Array.isArray(e.pos)&&e.pos.indexOf("-")!==-1){let o=e.pos.split("-");o.length===2&&o.every(i=>F(i))&&(r.position={x:parseFloat(o[0]),y:parseFloat(o[1])})}}if(e.q){let o=d(e.q,0);o>0&&(r.quality=o)}else t=="jpg"?r.quality=n.jpegQuality:t=="webp"&&(r.quality=n.webpQuality);return r}function w(e){let t=e.manipulations,n=`_${t.width}x${t.height}_${t.mode}_`;return typeof t.position=="string"?n+=t.position:n+=`${t.position.x.toFixed(3)}-${t.position.y.toFixed(3)}`,t.quality&&(n+=`_${t.quality}`),$(e.prefix,n,`${e.fileName}.${e.extension}`)}function $(...e){return e.filter(t=>t&&t.length>0).join("/")}function T(e,t){return e.startsWith(`/${t.rootPrefix}`)||e.startsWith(`${t.rootPrefix}/`)?e.slice(t.rootPrefix.length+1):e}var O={loggingEnabled:!0,rootPrefix:"Flux",sources:[],verifyQuery:!0,verifySecret:"",cachedEnabled:!0,bucket:"",region:"",jpegQuality:80,webpQuality:80,acceptWebp:!0};var N=(e,t,n)=>{let r=e.Records[0].cf.request,o=O;if(global&&global.fluxConfig)o=Object.assign({},o,global.fluxConfig);else return u(o,"Forwarding request, no config accessible"),n(null,r);u(o,"Parsing request",r.uri,r.querystring);let i=new URLSearchParams(r.querystring),s=Object.fromEntries(i);if(o.verifyQuery&&!R(r,s,o))return u(o,"Forwarding request, query verification failed"),n(null,r);let l=v(r,s,o);return l?(r.headers.host&&r.headers.host.length>0&&(r.headers["x-flux-original-request"]=[{key:"X-Flux-Original-Request",value:r.headers.host[0].value+r.uri}]),l.sourceFilename&&(r.headers["x-flux-source-filename"]=[{key:"X-Flux-Source-Filename",value:l.sourceFilename}]),r.uri="/"+w(l),u(o,"Modifying path to",r.uri),n(null,r)):(u(o,"Forwarding request, unable to parse"),n(null,r))};exports.handler=N;
/*!
 * Flux
 * Copyright(c) Chris Dyer
 */
//# sourceMappingURL=index.js.map
